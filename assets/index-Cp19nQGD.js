import{r as l,j as e}from"./index-9k0iNzam.js";import{N as _,S as T,s as $}from"./index-B61T4doZ.js";const q=80,I=1e3,A=2048,L=()=>{const[d,c]=l.useState(!1),[S,j]=l.useState(null),m=l.useRef(null),u=l.useRef(null),o=l.useRef(null),b=l.useRef(null),N=(r,i)=>{let n=r.length,a=0;for(let t=0;t<n;t++){const p=r[t];a+=p*p}if(a=Math.sqrt(a/n),a<.01)return-1;let s=0,x=n-1;const v=.2;for(let t=0;t<n/2;t++)if(Math.abs(r[t])<v){s=t;break}for(let t=1;t<n/2;t++)if(Math.abs(r[n-t])<v){x=n-t;break}r=r.slice(s,x),n=r.length;const f=new Array(n).fill(0);for(let t=0;t<n;t++)for(let p=0;p<n-t;p++)f[t]=f[t]+r[p]*r[p+t];let w=0;for(;f[w]>f[w+1];)w++;let F=-1,M=-1;for(let t=w;t<n;t++)f[t]>F&&(F=f[t],M=t);let y=M;const k=f[y-1],D=f[y],C=f[y+1],E=(k+C-2*D)/2,P=(C-k)/2;return E&&(y=y-P/(2*E)),i/y},z=r=>{const i=12*(Math.log(r/440)/Math.log(2)),n=Math.round(i)+69,a=Math.floor(n/12)-1,s=n%12,x=_[s],v=Math.floor((i-Math.round(i))*100);return{note:x,octave:a,cents:v}},h=()=>{if(!u.current)return;const r=new Float32Array(A);u.current.getFloatTimeDomainData(r);const i=N(r,m.current.sampleRate);if(i>q&&i<I){const{note:n,octave:a,cents:s}=z(i);j({frequency:i,note:n,octave:a,cents:s,clarity:1})}else j(null);b.current=requestAnimationFrame(h)},R=async()=>{try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});m.current=new AudioContext,u.current=m.current.createAnalyser(),u.current.fftSize=A*2,o.current=m.current.createMediaStreamSource(r),o.current.connect(u.current),c(!0),h()}catch(r){console.error("Error accessing microphone:",r)}},g=()=>{b.current&&cancelAnimationFrame(b.current),o.current&&o.current.disconnect(),u.current&&u.current.disconnect(),m.current&&m.current.close(),c(!1),j(null)};return l.useEffect(()=>()=>{d&&g()},[]),{isListening:d,pitch:S,start:R,stop:g}},H=()=>{const{isListening:d,pitch:c,start:S,stop:j}=L(),[m,u]=l.useState([]),[o,b]=l.useState("fuzzy"),[N,z]=l.useState("C"),[h,R]=l.useState(4),[g,r]=l.useState(!1),i=async()=>{await $.initialize(),$.playNotes([`${N}${h}`],"2n"),r(!0),setTimeout(()=>r(!1),1e3)};l.useEffect(()=>{c&&u(s=>{const x=c.note+c.octave;return o==="fuzzy"&&c.note.includes("#"),[...s,{note:x,timestamp:Date.now()}].slice(-10)})},[c?.note,c?.octave,o]);const a=(()=>{if(!c)return null;if(o==="precise")return c;let s=c.note;return c.note.includes("#")&&(s=c.note.replace("#","")),{...c,note:s}})();return e.jsxs("div",{className:"max-w-md mx-auto p-6 flex flex-col items-center gap-8 flex-1",children:[e.jsx("div",{className:"text-center space-y-2 w-full",children:e.jsx("div",{className:"flex justify-center mt-4",children:e.jsx(T,{value:o,onChange:b,options:[{value:"fuzzy",label:"模糊模式",icon:e.jsx("span",{className:"material-icons",style:{fontSize:"16px"},children:"filter_center_focus"})},{value:"precise",label:"精準模式",icon:e.jsx("span",{className:"material-icons",style:{fontSize:"16px"},children:"bolt"})}],size:"sm"})})}),e.jsxs("div",{className:"relative w-64 h-64 flex items-center justify-center mt-4",children:[e.jsx("div",{className:`
            absolute inset-0 rounded-full border-4 transition-all duration-300
            ${d?"border-primary/20 scale-100":"border-border/50 scale-95"}
         `}),e.jsx("div",{className:"relative z-10 text-center",children:d?a?e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-8xl font-black tracking-tighter text-foreground transition-all",children:a.note}),o==="precise"&&e.jsx("span",{className:"text-2xl font-medium opacity-60 mt-2",children:a.octave}),o==="precise"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-center gap-3",children:[e.jsxs("div",{className:"w-24 h-2 bg-secondary/30 rounded-full overflow-hidden relative",children:[e.jsx("div",{className:"absolute top-0 bottom-0 w-1 bg-foreground transition-all duration-100 left-1/2 -ml-0.5",style:{transform:`translateX(${a.cents}px)`}}),e.jsx("div",{className:"absolute top-0 bottom-0 left-1/2 w-0.5 bg-primary/50 -ml-px"})]}),e.jsxs("span",{className:`text-xs font-mono w-8 text-right ${Math.abs(a.cents)<10?"text-green-500":"text-foreground"}`,children:[a.cents>0?"+":"",a.cents]})]}),e.jsx("span",{className:"text-[10px] uppercase tracking-widest opacity-40 mt-1",children:"Cents"})]}):e.jsx("span",{className:"text-sm opacity-40 mt-4 tracking-widest uppercase",children:"Approx"})]}):e.jsxs("div",{className:"flex flex-col items-center opacity-30 animate-pulse",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"48px"},children:"graphic_eq"}),e.jsx("span",{className:"mt-2 text-sm",children:"Listening..."})]}):e.jsxs("div",{className:"flex flex-col items-center opacity-30",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"48px"},children:"mic_off"}),e.jsx("span",{className:"mt-2 text-sm",children:"Tap to Start"})]})})]}),e.jsx("button",{onClick:d?j:S,className:`
            w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2
            ${d?"bg-red-500/10 text-red-500 hover:bg-red-500/20":"bg-primary text-primary-foreground hover:opacity-90 shadow-lg hover:translate-y-[-2px]"}
        `,children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons",style:{fontSize:"20px"},children:"mic_off"})," Stop"]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons",style:{fontSize:"20px"},children:"mic"})," Start"]})}),e.jsxs("div",{className:"w-full bg-secondary/10 p-4 rounded-xl border border-border/50 mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 opacity-70",children:[e.jsx("span",{className:"material-icons",style:{fontSize:"16px"},children:"volume_up"}),e.jsx("h3",{className:"text-sm font-bold uppercase tracking-wider",children:"Reference Pitch"})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 scrollbar-hide w-full justify-start sm:justify-center",children:(o==="fuzzy"?["C","D","E","F","G","A","B"]:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]).map(s=>e.jsx("button",{onClick:()=>z(s),className:`
                            w-10 h-10 rounded-lg text-sm font-bold transition-all flex-shrink-0 flex items-center justify-center
                            ${N===s?"bg-primary text-primary-foreground shadow-md":"bg-background hover:bg-secondary/50 text-muted-foreground border border-border/50"}
                        `,children:s},s))}),e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"flex bg-background rounded-lg p-1 gap-1 border border-border/50",children:[3,4,5].map(s=>e.jsx("button",{onClick:()=>R(s),className:`
                                w-8 h-8 text-xs font-bold rounded transition-all flex items-center justify-center
                                ${h===s?"bg-primary/20 text-primary":"hover:bg-secondary/50 text-muted-foreground"}
                            `,children:s},s))}),e.jsxs("button",{onClick:i,className:`
                        flex-1 h-10 rounded-lg font-bold text-sm bg-secondary text-secondary-foreground flex items-center justify-center gap-2 transition-all active:scale-95 border border-border/50 hover:bg-secondary/80
                        ${g?"bg-primary text-primary-foreground border-primary":""}
                    `,children:[e.jsx("span",{className:`material-icons ${g?"text-current":""}`,style:{fontSize:"16px"},children:"play_arrow"}),g?"Playing...":`Play ${N}${h}`]})]})]})]}),d&&m.length>0&&o==="precise"&&e.jsx("div",{className:"w-full h-12 flex items-end justify-center gap-1 opacity-50",children:m.map((s,x)=>e.jsx("div",{className:"text-[10px] font-mono bg-secondary/20 px-1 rounded",children:s.note},x))})]})};export{H as default};
